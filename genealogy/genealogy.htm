<script>
  /* -----------------------------
     Footer year
  ------------------------------ */
  document.getElementById("year").textContent = new Date().getFullYear();

  /* -----------------------------
     Search / filter logic
  ------------------------------ */
  const legacy = document.getElementById("legacy");
  const q = document.getElementById("q");
  const chipsWrap = document.getElementById("chips");
  const clearBtn = document.getElementById("clearBtn");
  const showAllBtn = document.getElementById("showAllBtn");
  const matchCount = document.getElementById("matchCount");

  const targets = Array.from(legacy.querySelectorAll("p, li, tr"));

  function normalize(str){
    return (str || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function setActiveChip(value){
    chipsWrap.querySelectorAll(".chip").forEach(c =>
      c.classList.toggle("active", c.dataset.chip === value)
    );
  }

  function clearHighlights(){
    legacy.querySelectorAll("mark.hl").forEach(m => {
      m.replaceWith(document.createTextNode(m.textContent));
    });
    legacy.normalize();
  }

  function highlightInNode(el, needleRaw){
    const needle = needleRaw.trim();
    if(!needle) return 0;

    const needleN = normalize(needle);
    let hits = 0;

    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, {
      acceptNode(node){
        if(!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
        const p = node.parentElement;
        if(!p) return NodeFilter.FILTER_REJECT;
        const tag = p.tagName.toLowerCase();
        if(tag === "script" || tag === "style") return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }
    });

    const nodes = [];
    while(walker.nextNode()) nodes.push(walker.currentNode);

    for(const textNode of nodes){
      const raw = textNode.nodeValue;
      const rawN = normalize(raw);
      const idx = rawN.indexOf(needleN);
      if(idx === -1) continue;

      const before = raw.slice(0, idx);
      const match = raw.slice(idx, idx + needle.length);
      const after  = raw.slice(idx + needle.length);

      const frag = document.createDocumentFragment();
      if(before) frag.appendChild(document.createTextNode(before));

      const mark = document.createElement("mark");
      mark.className = "hl";
      mark.textContent = match;
      frag.appendChild(mark);

      if(after) frag.appendChild(document.createTextNode(after));

      textNode.parentNode.replaceChild(frag, textNode);
      hits++;
    }

    return hits;
  }

  function applyFilter(){
    const query = q.value.trim();
    clearHighlights();

    if(!query){
      targets.forEach(el => el.dataset.hit = "1");
      matchCount.textContent = "";
      return;
    }

    const qn = normalize(query);
    let shown = 0;
    let hl = 0;

    for(const el of targets){
      const text = normalize(el.textContent);
      const ok = text.includes(qn);
      el.dataset.hit = ok ? "1" : "0";
      if(ok){
        shown++;
        hl += highlightInNode(el, query);
      }
    }

    matchCount.textContent = `${shown} matching line(s) Â· ${hl} highlight(s)`;
  }

  chipsWrap.addEventListener("click", e => {
    const chip = e.target.closest(".chip");
    if(!chip) return;
    setActiveChip(chip.dataset.chip);
    q.value = chip.dataset.chip === "__all__" ? "" : chip.textContent;
    applyFilter();
  });

  q.addEventListener("input", () => {
    setActiveChip("__all__");
    applyFilter();
  });

  clearBtn.addEventListener("click", () => {
    q.value = "";
    setActiveChip("__all__");
    applyFilter();
    q.focus();
  });

  showAllBtn.addEventListener("click", () => {
    q.value = "";
    setActiveChip("__all__");
    clearHighlights();
    targets.forEach(el => el.dataset.hit = "1");
    matchCount.textContent = "";
  });

  /* -----------------------------
     Background music logic
  ------------------------------ */
  const bgm = document.getElementById("bgm");
  const musicBtn = document.getElementById("musicBtn");
  let musicOn = false;

  async function startMusic(){
    if(!bgm) return;
    try{
      await bgm.play();
      musicOn = true;
      if(musicBtn) musicBtn.textContent = "ðŸ”Š Music On";
    }catch(e){
      // Autoplay blocked until user interaction (normal)
    }
  }

  function stopMusic(){
    if(!bgm) return;
    bgm.pause();
    musicOn = false;
    if(musicBtn) musicBtn.textContent = "ðŸ”‡ Music Off";
  }

  // Attempt autoplay on load
  startMusic();

  // Enable on first user gesture
  const gestureEvents = ["click","keydown","touchstart","wheel"];
  const onFirstGesture = () => {
    startMusic();
    gestureEvents.forEach(ev =>
      window.removeEventListener(ev, onFirstGesture, { passive:true })
    );
  };
  gestureEvents.forEach(ev =>
    window.addEventListener(ev, onFirstGesture, { passive:true })
  );

  // Manual toggle
  if(musicBtn){
    musicBtn.addEventListener("click", async () => {
      if(musicOn) stopMusic();
      else await startMusic();
    });
  }

  // Initial render
  applyFilter();
</script>
