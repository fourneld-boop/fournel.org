<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Historical Chronology – fournel.org</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description"
        content="Deep-time historical chronology with interactive scrubber, filters, search, and timeline/cards views.">

  <style>
    :root{
      --bg:#020612;
      --glass:rgba(15,23,42,.78);
      --glass2:rgba(8,12,24,.86);
      --card:rgba(15,23,42,.92);
      --accent:#4fd1ff;
      --accent2:#a855ff;
      --text:#f4f7ff;
      --muted:#9ba4c4;
      --border:rgba(255,255,255,.12);
      --border2:rgba(148,163,253,.35);
      --shadow:0 22px 60px rgba(0,0,0,.7);
      --radius:18px;
      --max:1100px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      color:var(--text);
      background:#020612 url('wormhole.gif') center center fixed no-repeat;
      background-size:cover;
      overflow-x:hidden;
      position:relative;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    body::before{
      content:"";
      position:fixed;inset:0;
      background:
        radial-gradient(circle at 10% 0, rgba(15,23,42,0.92) 0, transparent 55%),
        radial-gradient(circle at 90% 0, rgba(76,29,149,0.78) 0, transparent 55%),
        radial-gradient(circle at 50% 80%, rgba(15,23,42,0.96) 0, rgba(3,7,18,0.98) 70%);
      z-index:-1;pointer-events:none;
    }

    .wormhole-ring{
      position:fixed;left:50%;top:42%;
      width:380px;height:380px;margin-left:-190px;margin-top:-190px;border-radius:50%;
      border:1px dashed rgba(158,195,255,.35);
      box-shadow:0 0 30px rgba(79,209,255,.45), 0 0 80px rgba(0,0,0,.9) inset;
      z-index:-1;pointer-events:none;opacity:.62;
      animation:spinRing 32s linear infinite reverse;
    }
    @keyframes spinRing{from{transform:rotate(0)}to{transform:rotate(-360deg)}}

    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(18px);
      background:radial-gradient(circle at top, rgba(15,23,42,.96), rgba(15,23,42,.88));
      border-bottom:1px solid var(--border);
    }
    .nav{
      max-width:var(--max);margin:0 auto;padding:.7rem 1.5rem;
      display:flex;align-items:center;justify-content:space-between;gap:1rem;
    }
    .nav-left{display:flex;align-items:center;gap:.7rem}
    .nav-logo{
      width:36px;height:36px;border-radius:999px;
      background:
        radial-gradient(circle at 30% 25%, #fff, #b9e6ff 48%, transparent 62%),
        radial-gradient(circle at 70% 75%, #a855ff, #22d3ee 55%, #020617 80%);
      box-shadow:0 0 0 2px rgba(255,255,255,.75), 0 0 40px rgba(59,130,246,.65);
    }
    .nav-title{font-weight:600;letter-spacing:.03em;font-size:.95rem}
    .nav-title span{color:var(--muted);display:block;font-size:.75rem;text-transform:uppercase}
    .nav-links{display:flex;gap:.85rem;flex-wrap:wrap;font-size:.86rem}
    .nav-links a{
      padding:.25rem .7rem;border-radius:999px;border:1px solid transparent;
      color:var(--muted);transition:.2s;
    }
    .nav-links a:hover{
      color:var(--text);
      border-color:rgba(79,209,255,.18);
      background:rgba(15,23,42,.78);
      transform:translateY(-1px);
      text-decoration:none;
    }
    .nav-links a.active{
      color:var(--text);
      border-color:rgba(79,209,255,.18);
      background:rgba(15,23,42,.95);
    }

    main{max-width:var(--max);margin:0 auto;padding:2.4rem 1.5rem 4rem;position:relative;z-index:1}

    .hero{
      display:grid;grid-template-columns:minmax(0,1.8fr) minmax(0,1.2fr);
      gap:1.2rem;align-items:start;margin-bottom:1.1rem;
    }
    .badge{
      display:inline-flex;padding:.22rem .7rem;border-radius:999px;
      border:1px solid rgba(56,189,248,.7);
      background:rgba(8,47,73,.96);
      font-size:.7rem;color:#bae6fd;text-transform:uppercase;letter-spacing:.13em;
    }
    h1{margin:.75rem 0 .35rem;font-size:clamp(2.1rem,2.3vw + 1.3rem,2.7rem)}
    .lede{margin:0;color:var(--muted);line-height:1.75;font-size:1.02rem;max-width:46rem}

    .hero-card{
      border-radius:var(--radius);
      padding:1rem 1.1rem 1.15rem;
      background:var(--card);
      border:1px solid rgba(148,163,253,.55);
      box-shadow:var(--shadow);
      font-size:.88rem;color:#e5e7ff;
    }
    .hero-card h2{margin:0 0 .35rem;font-size:1rem}
    .hero-card p{margin:.25rem 0 .4rem;color:var(--muted)}
    .hero-card ul{margin:.3rem 0 0;padding-left:1.1rem;color:var(--muted);font-size:.86rem}
    .hero-card li+li{margin-top:.16rem}

    .top-links{
      margin:.8rem 0 0;
      display:flex;flex-wrap:wrap;gap:.6rem;
    }
    .pilllink{
      display:inline-flex;align-items:center;justify-content:center;gap:.35rem;
      padding:.32rem .68rem;border-radius:999px;
      border:1px solid rgba(148,163,253,.65);
      background:rgba(30,64,175,.25);
      color:#e5e7ff;text-decoration:none;font-size:.84rem;font-weight:500;
      transition:.16s;
    }
    .pilllink:hover{
      border-color:rgba(79,209,255,.8);
      background:rgba(79,209,255,.14);
      transform:translateY(-1px);
      text-decoration:none;
    }

    .controls{
      border-radius:var(--radius);
      background:var(--glass);
      border:1px solid var(--border2);
      box-shadow:var(--shadow);
      padding:.8rem .9rem;
      display:grid;
      grid-template-columns:1.3fr 1fr 0.9fr;
      gap:.75rem;
      align-items:center;
      margin-top:1rem;
    }
    .search{
      display:flex;gap:.55rem;align-items:center;
      padding:.45rem .7rem;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,18,.45);
    }
    .search input{
      width:100%;background:transparent;border:none;outline:none;color:var(--text);font-size:.9rem;
    }
    .search input::placeholder{color:rgba(155,164,196,.85)}
    .chips{display:flex;flex-wrap:wrap;gap:.4rem}
    .chip{
      padding:.3rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,18,.38);
      color:var(--muted);font-size:.82rem;cursor:pointer;transition:.16s;user-select:none;white-space:nowrap;
    }
    .chip:hover{transform:translateY(-1px);border-color:rgba(79,209,255,.35);color:var(--text)}
    .chip.active{color:var(--text);border-color:rgba(79,209,255,.55);background:rgba(79,209,255,.12)}
    .view-toggle{display:flex;justify-content:flex-end;gap:.45rem;flex-wrap:wrap}
    .btn{
      padding:.45rem .75rem;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,18,.38);
      color:var(--muted);cursor:pointer;transition:.16s;font-size:.84rem;user-select:none;white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(79,209,255,.35);color:var(--text)}
    .btn.active{color:var(--text);border-color:rgba(79,209,255,.55);background:rgba(79,209,255,.12)}

    /* Scrubber */
    .scrubber{
      margin-top:.9rem;
      border-radius:var(--radius);
      background:rgba(15,23,42,.82);
      border:1px solid rgba(148,163,253,.35);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .scrubber-top{
      display:flex;justify-content:space-between;gap:1rem;align-items:center;
      padding:.75rem .95rem;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:radial-gradient(circle at top, rgba(15,23,42,.96), rgba(8,12,24,.96));
    }
    .scrubber-top h2{margin:0;font-size:1.05rem;letter-spacing:.02em}
    .scrubber-top .meta{color:var(--muted);font-size:.86rem}
    .scrubber-bar{padding:.8rem .95rem 1rem;background:rgba(8,12,24,.72)}
    .range-row{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;color:var(--muted);font-size:.86rem}
    input[type="range"]{width:420px;max-width:100%;accent-color:var(--accent)}
    .year-pill{
      padding:.28rem .65rem;border-radius:999px;
      border:1px solid rgba(148,163,253,.35);
      background:rgba(2,6,18,.35);
      color:#e5e7ff;font-size:.84rem;
    }
    .jump{margin-left:auto;display:flex;gap:.45rem;flex-wrap:wrap}
    .jump button{
      all:unset;cursor:pointer;
      padding:.32rem .7rem;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,18,.38);
      color:var(--muted);font-size:.84rem;
      transition:.16s;
    }
    .jump button:hover{transform:translateY(-1px);border-color:rgba(79,209,255,.35);color:var(--text)}

    /* Timeline shell */
    .timeline-shell{
      margin-top:1rem;
      border-radius:var(--radius);
      background:rgba(15,23,42,.84);
      border:1px solid rgba(148,163,253,.35);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .timeline-topbar{
      display:flex;justify-content:space-between;gap:.9rem;align-items:baseline;
      padding:.85rem 1rem;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:radial-gradient(circle at top, rgba(15,23,42,.96), rgba(8,12,24,.96));
    }
    .timeline-topbar h2{margin:0;font-size:1.05rem;letter-spacing:.02em}
    .timeline-topbar .meta{color:var(--muted);font-size:.86rem}

    /* Collapsible clusters */
    details.cluster{
      border-top:1px solid rgba(255,255,255,.06);
      background:rgba(8,12,24,.60);
    }
    details.cluster[open]{background:rgba(8,12,24,.72)}
    summary.cluster-head{
      list-style:none;
      cursor:pointer;
      padding:.8rem 1rem;
      display:flex;align-items:center;justify-content:space-between;gap:1rem;
      user-select:none;
    }
    summary.cluster-head::-webkit-details-marker{display:none}
    .cluster-left{display:flex;align-items:center;gap:.65rem;flex-wrap:wrap}
    .cluster-title{font-size:.95rem;color:var(--text);margin:0}
    .cluster-sub{color:var(--muted);font-size:.84rem}
    .cluster-badge{
      padding:.22rem .6rem;border-radius:999px;
      border:1px solid rgba(79,209,255,.25);
      background:rgba(79,209,255,.08);
      color:#dff6ff;font-size:.78rem;
    }
    .chev{
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,18,.30);
      color:var(--muted);
      transition:.16s;
    }
    details[open] .chev{transform:rotate(180deg);border-color:rgba(79,209,255,.35);color:var(--text)}
    .cluster-body{padding:.85rem 1rem 1.1rem}

    .entries{display:flex;flex-direction:column;gap:.8rem}
    .entry{display:grid;grid-template-columns:46px 1fr;gap:.85rem;align-items:start;position:relative}
    .rail-col{display:flex;justify-content:center;position:relative}
    .rail-col::before{
      content:"";
      position:absolute;top:-10px;bottom:-10px;width:3px;border-radius:999px;
      background:linear-gradient(180deg, rgba(79,209,255,0.0), rgba(79,209,255,0.5), rgba(168,85,255,0.55), rgba(79,209,255,0.0));
      box-shadow:0 0 18px rgba(79,209,255,0.35);
      opacity:.85;
    }
    .node{
      width:18px;height:18px;border-radius:50%;
      margin-top:.4rem;
      background:radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), rgba(79,209,255,.7), rgba(2,6,18,.2));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 0 18px rgba(79,209,255,.45);
      position:relative;
    }
    .node::after{
      content:"";position:absolute;inset:-10px;border-radius:999px;
      background:radial-gradient(circle, rgba(79,209,255,.18), transparent 60%);
      opacity:.8;
    }

    .tile{
      border-radius:var(--radius);
      background:rgba(15,23,42,.94);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 12px 40px rgba(0,0,0,.45);
      padding:.85rem .95rem .9rem;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      outline:none;
    }
    .tile::before{
      content:"";
      position:absolute;inset:0;
      background:
        radial-gradient(circle at 12% 15%, rgba(79,209,255,.12), transparent 42%),
        radial-gradient(circle at 88% 80%, rgba(168,85,255,.12), transparent 44%);
      pointer-events:none;
    }
    .tile:focus-visible{
      box-shadow:0 0 0 3px rgba(79,209,255,.35), 0 12px 40px rgba(0,0,0,.45);
      border-color:rgba(79,209,255,.45);
    }

    .kicker{
      display:inline-flex;align-items:center;gap:.45rem;
      font-size:.76rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;
      margin-bottom:.35rem;position:relative;
    }
    .tag{
      padding:.18rem .5rem;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,18,.35);font-size:.72rem;color:var(--muted);
    }
    .title{margin:0 0 .2rem;font-size:1.02rem;color:var(--text);letter-spacing:.01em;position:relative}
    .range{color:var(--muted);font-size:.86rem;margin:0 0 .35rem;position:relative}
    .desc{margin:0 0 .55rem;color:var(--muted);line-height:1.6;font-size:.92rem;position:relative}
    .actions{display:flex;flex-wrap:wrap;gap:.45rem;align-items:center;position:relative}

    /* Cards view */
    .cards-wrap{display:none;margin-top:1rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.1rem}
    .card{
      padding:1rem 1.15rem 1.1rem;
      border-radius:var(--radius);
      background:rgba(15,23,42,.94);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);
      color:var(--muted);
      position:relative;overflow:hidden;
    }
    .card::before{
      content:"";position:absolute;inset:0;
      background:
        radial-gradient(circle at 12% 15%, rgba(79,209,255,.10), transparent 44%),
        radial-gradient(circle at 88% 80%, rgba(168,85,255,.10), transparent 46%);
      pointer-events:none;
    }
    .card h3{margin:0 0 .35rem;font-size:1rem;color:var(--accent);position:relative}
    .card p{margin:0 0 .55rem;position:relative}
    .card .pilllink{position:relative}

    .empty{
      padding:1rem;
      color:var(--muted);
      font-size:.92rem;
      line-height:1.6;
      border:1px dashed rgba(255,255,255,.14);
      border-radius:14px;
      background:rgba(2,6,18,.30);
    }
    .smallnote{
      color:rgba(155,164,196,.9);
      font-size:.86rem;
    }

    footer{
      max-width:var(--max);margin:0 auto;
      padding:1.4rem 1.5rem 1.6rem;
      font-size:.8rem;color:var(--muted);
      border-top:1px solid rgba(15,23,42,.8);
      text-align:center;
      background:radial-gradient(circle at top, rgba(15,23,42,.96), rgba(3,7,18,.96));
    }

    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
      .controls{grid-template-columns:1fr}
      .view-toggle{justify-content:flex-start}
    }
  </style>
</head>

<body>
  <div class="wormhole-ring"></div>

  <header>
    <nav class="nav">
      <div class="nav-left">
        <div class="nav-logo"></div>
        <div class="nav-title">
          fournel.org
          <span>Historical Chronology</span>
        </div>
      </div>
      <!-- Keep existing nav buttons (as on your current history.htm) -->
      <div class="nav-links">
        <a href="home.htm">Home</a>
        <a href="history.htm" class="active">History</a>
        <a href="tech.htm">Technology</a>
        <a href="about.htm">About</a>
      </div>
    </nav>
  </header>

  <main>
    <!-- Keep your existing intro content + links -->
    <section class="hero">
      <div>
        <div class="badge">Deep time · long arcs</div>
        <h1>Historical Chronology</h1>
        <p class="lede">
          This is a long-form chronology that runs from the Neolithic through ancient civilizations, empires,
          religions, and modern history. It’s part reference document, part personal project, and it pairs with
          the <a href="tech.htm">technology timeline</a> on <a href="home.htm">the main wormhole page</a>.
        </p>

        <div class="top-links">
          <a class="pilllink" href="home.htm">← Back to wormhole home</a>
          <a class="pilllink" href="tech.htm">Jump to technology timeline</a>
        </div>
      </div>

      <aside class="hero-card">
        <h2>How to read this timeline</h2>
        <p>
          Years march downward. The focus is on big structures: civilizations, dynasties, cultural shifts,
          and turning points that shaped the world we live in.
        </p>
        <ul>
          <li><strong>Scrub time</strong> to jump to the nearest entry.</li>
          <li><strong>Search</strong> for people/places/empires.</li>
          <li><strong>Filter</strong> by era cluster.</li>
          <li><strong>Cards view</strong> if you prefer scanning.</li>
        </ul>
        <p class="smallnote" style="margin-top:.55rem;">
          “Links will be gradually updated away from archived Wayback URLs where possible.”
        </p>
      </aside>
    </section>

    <!-- Controls -->
    <section class="controls" aria-label="Timeline controls">
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(244,247,255,0.9)" stroke-width="1.6"/>
          <path d="M16.5 16.5 21 21" stroke="rgba(244,247,255,0.9)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <input id="q" type="search" placeholder="Search history (e.g., 'Rome', 'Mongols', 'printing', 'WWII')…" />
      </div>

      <div class="chips" aria-label="Filter chips">
        <div class="chip active" data-filter="all">All</div>
        <div class="chip" data-filter="pre">Prehistory</div>
        <div class="chip" data-filter="anc">Ancient</div>
        <div class="chip" data-filter="med">Medieval</div>
        <div class="chip" data-filter="mod">Modern</div>
      </div>

      <div class="view-toggle" aria-label="View toggle">
        <div class="btn active" id="viewTimeline" role="button" tabindex="0">Timeline</div>
        <div class="btn" id="viewCards" role="button" tabindex="0">Cards</div>
      </div>
    </section>

    <!-- Scrubber (supports BC years as negative numbers; present AD as positive) -->
    <section class="scrubber" aria-label="Time scrubber">
      <div class="scrubber-top">
        <h2>Time Scrubber</h2>
        <div class="meta">Drag to jump through time. Nearest entry will highlight.</div>
      </div>
      <div class="scrubber-bar">
        <div class="range-row">
          <span class="year-pill" id="yearPill">Year: 0</span>
          <input id="yearRange" type="range" min="-10000" max="2025" value="-3000" />
          <div class="jump">
            <button data-jump="-10000">10,000 BC</button>
            <button data-jump="-3000">3000 BC</button>
            <button data-jump="-500">500 BC</button>
            <button data-jump="500">500 AD</button>
            <button data-jump="1500">1500</button>
            <button data-jump="1945">1945</button>
            <button data-jump="2025">2025</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Timeline -->
    <section class="timeline-shell" id="timelineShell" aria-label="Timeline view">
      <div class="timeline-topbar">
        <h2>The Chronology</h2>
        <div class="meta"><span id="count">0</span> entries · click a node to follow its link (if present)</div>
      </div>

      <!-- Clusters -->
      <details class="cluster" open data-cluster="pre">
        <summary class="cluster-head">
          <div class="cluster-left">
            <span class="cluster-badge">Cluster</span>
            <div>
              <div class="cluster-title">Prehistory</div>
              <div class="cluster-sub">Deep past to early farming</div>
            </div>
          </div>
          <div class="chev">▾</div>
        </summary>
        <div class="cluster-body">
          <div class="entries" id="entriesPre"></div>
        </div>
      </details>

      <details class="cluster" open data-cluster="anc">
        <summary class="cluster-head">
          <div class="cluster-left">
            <span class="cluster-badge">Cluster</span>
            <div>
              <div class="cluster-title">Ancient</div>
              <div class="cluster-sub">Early states, empires, religions, classical world</div>
            </div>
          </div>
          <div class="chev">▾</div>
        </summary>
        <div class="cluster-body">
          <div class="entries" id="entriesAnc"></div>
        </div>
      </details>

      <details class="cluster" open data-cluster="med">
        <summary class="cluster-head">
          <div class="cluster-left">
            <span class="cluster-badge">Cluster</span>
            <div>
              <div class="cluster-title">Medieval</div>
              <div class="cluster-sub">Post-classical to early modern transitions</div>
            </div>
          </div>
          <div class="chev">▾</div>
        </summary>
        <div class="cluster-body">
          <div class="entries" id="entriesMed"></div>
        </div>
      </details>

      <details class="cluster" open data-cluster="mod">
        <summary class="cluster-head">
          <div class="cluster-left">
            <span class="cluster-badge">Cluster</span>
            <div>
              <div class="cluster-title">Modern</div>
              <div class="cluster-sub">Industrial era to today</div>
            </div>
          </div>
          <div class="chev">▾</div>
        </summary>
        <div class="cluster-body">
          <div class="entries" id="entriesMod"></div>
        </div>
      </details>

      <div id="emptyState" class="empty" style="margin:1rem; display:none;">
        <strong>No parsed entries found.</strong>
        <div class="smallnote" style="margin-top:.35rem;">
          Add your existing timeline text into <code>RAW_TIMELINE_TEXT</code> (inside this file) and refresh.
          Your links will be preserved if you include them in Markdown like: <code>[Text](https://...)</code>.
        </div>
      </div>
    </section>

    <!-- Cards -->
    <section class="cards-wrap" id="cardsWrap" aria-label="Cards view">
      <div class="grid" id="cards"></div>
    </section>
  </main>

  <footer>
    © <span id="year"></span> Dan Fournel · fournel.org Historical Chronology · hosted on GitHub Pages
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    /*
      ✅ KEEP THE SAME DATA + LINKS:
      Paste your existing chronology (your current list) into RAW_TIMELINE_TEXT below.
      Format supported:

      -3000 | Ancient | Sumer and early states form in Mesopotamia
      -44   | Ancient | Julius Caesar assassinated [link](https://...)
      476   | Medieval | Fall of Western Roman Empire
      1492  | Modern | Columbus reaches the Americas

      Rules:
      - Year can be negative (BC) or positive (AD).
      - Era must be one of: Prehistory, Ancient, Medieval, Modern (case-insensitive).
      - Text can include Markdown links: [text](url)
      - If you already have headings/sections, just copy the bullets and convert to the 3-column format above.
    */

    const RAW_TIMELINE_TEXT = `
      <!-- PASTE YOUR EXISTING DATA HERE (one entry per line) -->

      <!-- Example lines (delete these after pasting your real data) -->
      -10000 | Prehistory | Early agriculture begins in multiple regions; permanent settlements expand.
      -3000  | Ancient | First large city-states in Mesopotamia and Egypt; writing systems emerge.
      -500   | Ancient | Classical civilizations expand; philosophy and imperial structures deepen.
      476    | Medieval | Western Roman imperial authority collapses; post-classical states form.
      1492   | Modern | Atlantic world connects permanently; early globalization accelerates.
      1789   | Modern | French Revolution reshapes political legitimacy in Europe.
      1914   | Modern | World War I begins; empires fracture and nationalism surges.
      1945   | Modern | World War II ends; UN era begins; decolonization accelerates.
    `;

    // ===== Parsing utilities =====
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatYear(y){
      const n = Number(y);
      if(Number.isNaN(n)) return String(y);
      if(n < 0) return `${Math.abs(n)} BC`;
      if(n === 0) return `0`;
      return `${n} AD`;
    }

    function normEra(s){
      const t = (s || "").trim().toLowerCase();
      if(t.startsWith("pre")) return "pre";
      if(t.startsWith("anc")) return "anc";
      if(t.startsWith("med")) return "med";
      if(t.startsWith("mod")) return "mod";
      // allow full words
      if(t.includes("preh")) return "pre";
      if(t.includes("anc")) return "anc";
      if(t.includes("med")) return "med";
      if(t.includes("mod")) return "mod";
      return "mod";
    }

    function eraLabel(key){
      return ({pre:"Prehistory", anc:"Ancient", med:"Medieval", mod:"Modern"})[key] || "Modern";
    }

    // Convert Markdown links in text to HTML links (basic, safe-ish)
    function mdLinksToHtml(text){
      // [label](url)
      return text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m, label, url) => {
        const safeLabel = escapeHtml(label);
        const safeUrl = escapeHtml(url);
        return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeLabel}</a>`;
      });
    }

    function parseRaw(raw){
      const lines = raw
        .split("\n")
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("<!--"));

      const nodes = [];
      let idc = 1;

      for(const line of lines){
        const parts = line.split("|").map(p => p.trim());
        if(parts.length < 3) continue;

        const year = Number(parts[0]);
        const eraKey = normEra(parts[1]);
        const text = parts.slice(2).join(" | ").trim();

        // If the line contains an explicit URL (not Markdown), capture first URL as href
        const urlMatch = text.match(/https?:\/\/\S+/);
        const href = urlMatch ? urlMatch[0].replace(/[).,;]+$/, "") : null;

        nodes.push({
          id: `h${idc++}`,
          year: Number.isNaN(year) ? 0 : year,
          era: eraKey,
          eraLabel: eraLabel(eraKey),
          title: text,
          titleHtml: mdLinksToHtml(escapeHtml(text)), // safe escaped then linkified
          href: href
        });
      }

      // Sort descending (years march downward)
      nodes.sort((a,b) => b.year - a.year);
      return nodes;
    }

    // ===== UI wiring =====
    const qEl = document.getElementById("q");
    const chipEls = Array.from(document.querySelectorAll(".chip"));
    const countEl = document.getElementById("count");

    const entriesPre = document.getElementById("entriesPre");
    const entriesAnc = document.getElementById("entriesAnc");
    const entriesMed = document.getElementById("entriesMed");
    const entriesMod = document.getElementById("entriesMod");

    const cardsWrap = document.getElementById("cardsWrap");
    const timelineShell = document.getElementById("timelineShell");
    const cardsEl = document.getElementById("cards");

    const viewTimelineBtn = document.getElementById("viewTimeline");
    const viewCardsBtn = document.getElementById("viewCards");

    const yearRange = document.getElementById("yearRange");
    const yearPill = document.getElementById("yearPill");
    const jumpButtons = Array.from(document.querySelectorAll(".jump button"));

    const emptyState = document.getElementById("emptyState");

    let activeFilter = "all";
    let selectedId = null;

    const ALL = parseRaw(RAW_TIMELINE_TEXT);

    function matches(node, query){
      if(!query) return true;
      const q = query.toLowerCase().trim();
      const hay = `${node.year} ${node.eraLabel} ${node.title}`.toLowerCase();
      return hay.includes(q);
    }

    function filterNodes(){
      const query = qEl.value || "";
      return ALL.filter(n => {
        const okEra = (activeFilter === "all") ? true : n.era === activeFilter;
        return okEra && matches(n, query);
      });
    }

    function setView(view){
      const isTimeline = view === "timeline";
      timelineShell.style.display = isTimeline ? "block" : "none";
      cardsWrap.style.display = isTimeline ? "none" : "block";
      viewTimelineBtn.classList.toggle("active", isTimeline);
      viewCardsBtn.classList.toggle("active", !isTimeline);
    }

    function setFilter(filter){
      activeFilter = filter;
      chipEls.forEach(c => c.classList.toggle("active", c.dataset.filter === filter));
      render();
    }

    function entryHtml(n){
      const kicker = `${escapeHtml(n.eraLabel)} · ${escapeHtml(formatYear(n.year))}`;
      const linkBtn = n.href
        ? `<a class="pilllink" href="${escapeHtml(n.href)}" target="_blank" rel="noopener noreferrer">Open link</a>`
        : "";

      return `
        <div class="entry" data-id="${escapeHtml(n.id)}" data-year="${n.year}">
          <div class="rail-col" aria-hidden="true"><div class="node"></div></div>
          <div class="tile" tabindex="0" role="button" aria-label="Select ${escapeHtml(n.title)}">
            <div class="kicker">
              <span>${kicker}</span>
              <span class="tag">${escapeHtml(n.eraLabel)}</span>
            </div>
            <div class="title">${n.titleHtml}</div>
            <div class="range">${escapeHtml(formatYear(n.year))}</div>
            <div class="actions">${linkBtn}</div>
          </div>
        </div>
      `;
    }

    function cardHtml(n){
      const linkBtn = n.href
        ? `<a class="pilllink" href="${escapeHtml(n.href)}" target="_blank" rel="noopener noreferrer">Open link</a>`
        : "";
      return `
        <div class="card">
          <h3>${n.titleHtml}</h3>
          <p><span style="color:var(--muted)">${escapeHtml(n.eraLabel)}</span> · <span style="color:var(--muted)">${escapeHtml(formatYear(n.year))}</span></p>
          ${linkBtn}
        </div>
      `;
    }

    function selectNode(id, {scrollIntoView=false} = {}){
      selectedId = id;
      document.querySelectorAll(".tile.selected").forEach(t => t.classList.remove("selected"));
      const entry = document.querySelector(`.entry[data-id="${CSS.escape(id)}"]`);
      if(entry){
        const tile = entry.querySelector(".tile");
        if(tile) tile.classList.add("selected");
        if(scrollIntoView) entry.scrollIntoView({behavior:"smooth", block:"center"});
      }
    }

    function updateYearPill(y){
      yearPill.textContent = `Year: ${formatYear(y)}`;
    }

    function nearestNodeToYear(year){
      const nodes = filterNodes();
      if(!nodes.length) return null;

      // Choose nearest by absolute year distance
      let best = null, bestDist = Infinity;
      for(const n of nodes){
        const dist = Math.abs(year - n.year);
        if(dist < bestDist){
          bestDist = dist;
          best = n;
        }
      }
      return best;
    }

    function render(){
      const nodes = filterNodes();
      countEl.textContent = String(nodes.length);

      emptyState.style.display = (ALL.length === 0) ? "block" : "none";

      const pre = nodes.filter(n => n.era === "pre");
      const anc = nodes.filter(n => n.era === "anc");
      const med = nodes.filter(n => n.era === "med");
      const mod = nodes.filter(n => n.era === "mod");

      entriesPre.innerHTML = pre.map(entryHtml).join("") || `<div class="empty">No entries in this cluster (with current filter/search).</div>`;
      entriesAnc.innerHTML = anc.map(entryHtml).join("") || `<div class="empty">No entries in this cluster (with current filter/search).</div>`;
      entriesMed.innerHTML = med.map(entryHtml).join("") || `<div class="empty">No entries in this cluster (with current filter/search).</div>`;
      entriesMod.innerHTML = mod.map(entryHtml).join("") || `<div class="empty">No entries in this cluster (with current filter/search).</div>`;

      cardsEl.innerHTML = nodes.map(cardHtml).join("") || `<div class="empty">No entries match your filter/search.</div>`;

      // Attach tile handlers
      document.querySelectorAll(".entry").forEach(entry => {
        const id = entry.dataset.id;
        const tile = entry.querySelector(".tile");
        if(!tile) return;

        tile.addEventListener("click", (e) => {
          if(e.target && e.target.closest("a")) return;
          selectNode(id);
        });

        tile.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            selectNode(id, {scrollIntoView:true});
          }
        });
      });

      // Auto-select first visible if needed
      if(selectedId){
        const still = nodes.some(n => n.id === selectedId);
        if(!still) selectedId = null;
      }
      if(!selectedId && nodes.length){
        selectNode(nodes[0].id);
      } else if(selectedId){
        selectNode(selectedId);
      }

      // Keep scrubber range sensible based on parsed data (optional)
      if(ALL.length){
        const minY = Math.min(...ALL.map(n => n.year));
        const maxY = Math.max(...ALL.map(n => n.year));
        // only expand if your data exceeds current bounds
        yearRange.min = String(Math.min(minY, Number(yearRange.min)));
        yearRange.max = String(Math.max(maxY, Number(yearRange.max)));
      }
    }

    // Controls
    qEl.addEventListener("input", () => render());
    chipEls.forEach(chip => chip.addEventListener("click", () => setFilter(chip.dataset.filter)));

    viewTimelineBtn.addEventListener("click", () => setView("timeline"));
    viewCardsBtn.addEventListener("click", () => setView("cards"));

    [viewTimelineBtn, viewCardsBtn].forEach(btn => {
      btn.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault(); btn.click();
        }
      });
    });

    // Scrubber behavior
    yearRange.addEventListener("input", () => {
      const y = parseInt(yearRange.value, 10);
      updateYearPill(y);
      const nearest = nearestNodeToYear(y);
      if(nearest) selectNode(nearest.id);
    });

    jumpButtons.forEach(b => {
      b.addEventListener("click", () => {
        const y = parseInt(b.dataset.jump, 10);
        yearRange.value = String(y);
        updateYearPill(y);
        const nearest = nearestNodeToYear(y);
        if(nearest) selectNode(nearest.id, {scrollIntoView:true});
      });
    });

    // Init
    setView("timeline");
    setFilter("all");
    updateYearPill(parseInt(yearRange.value,10));
    render();
  </script>
</body>
</html>
